import 'dotenv/config.js' // eslint-disable-line import/no-unassigned-import
import express from 'express'
import queue from '../../util/queue.cjs'
import auth from '../../middleware/auth.js'
import {getDistricts} from '../district/models.js'

const exportToExploitationDBQueue = queue('export-to-exploitation-db')

const app = new express.Router()

app.route('/districts')
  .post(auth, async (req, res) => {
    let response
    try {
      const {districtIDs} = req.body

      if (!districtIDs || districtIDs.length === 0) {
        res.status(400).send('districtIDs should not be empty')
      }

      const districts = await getDistricts(districtIDs)
      if (districts.length !== districtIDs.length) {
        res.status(404).send('Some districts not found')
      }

      await Promise.all(districtIDs.map(async districtID => exportToExploitationDBQueue.add({districtID}, {removeOnComplete: true, removeOnFail: true})))

      response = {
        date: new Date(),
        status: 'success',
        response: {},
      }
    } catch (error) {
      const {message} = error
      response = {
        date: new Date(),
        status: 'error',
        message,
        response: {},
      }
    }

    res.send(response)
  })

export default app

