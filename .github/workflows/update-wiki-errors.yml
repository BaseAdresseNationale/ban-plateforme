# .github/workflows/update-wiki-errors.yml
name: Update Wiki Errors Board

on:
  schedule:
    - cron: '0 * * * *'  # Toutes les heures
  workflow_dispatch:  # Lancement manuel
  push:  # Sur tous les push de toutes les branches
  pull_request:  # Sur toutes les PR

jobs:
  update-wiki:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout wiki
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          token: ${{ secrets.GITHUB_TOKEN }}
          path: wiki
      
      - name: Fetch errors and generate board
        run: |
          # RÃ©cupÃ©rer les donnÃ©es
          curl -s "https://plateforme.adresse.data.gouv.fr/api/alerts/errors-summary?limit=50" > errors.json
          
          # Date de mise Ã  jour
          TIMESTAMP=$(date -u +"%d/%m/%Y Ã  %H:%M:%S UTC")
          
          # Compter les erreurs
          TOTAL=$(jq '.response.communes | length' errors.json)
          
          # CrÃ©er le tableau
          cat > wiki/Errors-Board.md << 'EOF'
          # ðŸš¨ Errors Board
          
          EOF
          
          echo "**DerniÃ¨re mise Ã  jour :** ${TIMESTAMP}" >> wiki/Errors-Board.md
          echo "" >> wiki/Errors-Board.md
          echo "**DerniÃ¨re mise Ã  jour du markdown :** ${TIMESTAMP}" >> wiki/Errors-Board.md
          echo "" >> wiki/Errors-Board.md
          echo "**Total :** ${TOTAL} erreurs" >> wiki/Errors-Board.md
          echo "" >> wiki/Errors-Board.md
          echo "| Commune | COG | Date | Message d'erreur |" >> wiki/Errors-Board.md
          echo "|---------|-----|------|------------------|" >> wiki/Errors-Board.md
          
          # Fonction de parsing en jq (similaire au code React)
          jq -r '.response.communes[] | 
          . as $item |
          ($item.message | ascii_downcase) as $lower |
          
          # Parser le message
          (if ($lower | contains("job") and contains("Ã©chouÃ©")) then
            if ($item.message | contains("updateDate is a required field")) then
              "ðŸ”´ Date mise Ã  jour manquante"
            else
              "ðŸ”´ Erreur interne - contacter le support"
            end
          elif ($lower | contains("droits manquants")) then
            "ðŸ”´ Droits manquants"
          elif ($lower | contains("opÃ©ration non autorisÃ©e")) then
            "ðŸ”´ OpÃ©ration non autorisÃ©e - Identifiants dÃ©jÃ  utilisÃ©s"
          elif ($lower | contains("seuil de suppression") or contains("exceeded")) then
            "ðŸ”´ Seuil de suppression dÃ©passÃ©"
          elif ($lower | contains("addressid manquant")) then
            "ðŸ”´ addressID manquant - Consulter rapport de validation"
          elif ($lower | contains("districtid manquant")) then
            "ðŸ”´ districtID manquant - Consulter rapport de validation"
          elif ($lower | contains("maintopoid manquant")) then
            "ðŸ”´ mainTopoID manquant - Consulter rapport de validation"
          elif ($lower | contains("ids manquants")) then
            "ðŸ”´ IDs manquants - Consulter rapport de validation"
          elif ($lower | contains("enregistrement de la bal sans les identifiants")) then
            "ðŸ”´ Enregistrement sans identifiants - Consulter rapport"
          elif ([$lower | contains("api ban"), contains("api dump"), contains("timeout")] | any) then
            "ðŸ”´ Erreur interne - contactez le support"
          else
            "ðŸ”´ " + ($item.message | split("\n")[0] | .[0:80])
          end) as $parsed |
          
          "| \($item.districtName) | `\($item.cog)` | \($item.createdAt[0:10]) | \($parsed) |"
          ' errors.json >> wiki/Errors-Board.md
          
      - name: Commit and push
        working-directory: wiki
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Errors-Board.md
          git diff --quiet && git diff --staged --quiet || (
            git commit -m "Mise Ã  jour automatique du board"
            git push
          )