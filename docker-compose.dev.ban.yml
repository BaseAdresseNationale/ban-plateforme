# docker-compose.dev.ban.yml
# Stack DEV BAN — services infra + outils
#
# Points clés:
# - Healthchecks sur RabbitMQ, PostgreSQL et MongoDB
# - depends_on avec condition: service_healthy pour mongo-express et pgadmin
# - container_name stables (ban_rabbitmq, ban_postgres, ban_mongo, …)

services:
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: ban_rabbitmq
    ports:
      - "5672:5672"    # AMQP
      - "15672:15672"  # UI management
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped
    networks:
      - ban-net

  mongo:
    image: mongo:6
    container_name: ban_mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      # Retourne 1 si OK, on grep 1
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' | grep 1"]
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped
    networks:
      - ban-net

  mongo-express:
    image: mongo-express:1
    container_name: ban_mongo_express
    ports:
      - "8081:8081"
    environment:
      # Utilise le container_name pour éviter les surprises
      ME_CONFIG_MONGODB_SERVER: ban_mongo
      ME_CONFIG_SITE_BASEURL: /
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    depends_on:
      mongo:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ban-net

  postgres:
    container_name: ban_postgres_postal
    build:
      dockerfile: ./apps/postal-code/docker/postgres.Dockerfile
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_ROOT_USER}
      - POSTGRES_PASSWORD=${POSTGRES_ROOT_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_BAN_USER=${POSTGRES_BAN_USER}
      - POSTGRES_BAN_PASSWORD=${POSTGRES_BAN_PASSWORD}
    volumes:
      - pg_data_postal:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    networks:
      - ban-net


  pgadmin:
    image: dpage/pgadmin4:8
    container_name: ban_pgadmin
    ports:
      - "8082:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@ban.fr
      PGADMIN_DEFAULT_PASSWORD: admin
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ban-net

volumes:
  mongo_data:
  pg_data_postal:

networks:
  ban-net:
    driver: bridge
